<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Daily Productivity Form (Make)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@600&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root{--gap:12px}
    body{font-family:'Sarabun',sans-serif;max-width:1024px;margin:24px auto;padding:0 12px;background:#fafafa}
    h2{font-family:'Prompt',sans-serif;margin:0 0 16px;text-align:center}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:var(--gap)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,textarea,button{font-family:'Sarabun',sans-serif;font-size:16px}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:10px;background:#fff;box-sizing:border-box}
    textarea{resize:vertical}
    table{width:100%;border-collapse:collapse;margin-top:16px;background:#fff;border-radius:12px;overflow:hidden}
    th,td{border:1px solid #eee;padding:8px;vertical-align:top}
    th{background:#f4f6f8;text-align:left}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.danger{background:#fff0f0;color:#a00;border-color:#f3caca}
    .btn.active{background:#059669;color:#fff;border-color:#059669}
    .muted{opacity:.7}
    #preview{display:none;margin-top:20px;background:#fff;border:1px solid #eee;border-radius:12px;padding:12px}
    #msg{margin-top:8px;font-weight:700}
    .hidden{display:none !important}
    .mode-switch{text-align:center;margin-bottom:24px;padding:12px;background:#fff;border-radius:12px}
    #manageSection{background:#fff;padding:20px;border-radius:12px;margin-top:20px}
    .search-box{display:flex;gap:8px;align-items:end;margin:20px 0}
    .data-table{overflow-x:auto}
    .data-table td textarea{min-height:60px}
    .data-table td input[type="number"]{width:80px}
  </style>
</head>
<body>
  <h2>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° Productivity ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î -->
  <div class="mode-switch">
    <button type="button" class="btn active" id="btnModeCreate" onclick="showMode('create')">
      ‚ûï ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    </button>
    <button type="button" class="btn" id="btnModeManage" onclick="showMode('manage')">
      üìù ‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    </button>
  </div>

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà -->
  <form id="productivity-form" autocomplete="off">
    <div class="grid">
      <div>
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
        <input name="name" required>
      </div>
      <div>
        <label>‡∏ù‡πà‡∏≤‡∏¢/‡πÅ‡∏ú‡∏ô‡∏Å</label>
        <input name="department" required>
      </div>
      <div>
        <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏á‡∏≤‡∏ô</label>
        <input name="unit" required>
      </div>
      <div>
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input id="date" name="date" placeholder="‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ" required>
      </div>
      <div>
        <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)</label>
        <select name="month" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô --</option>
          <option value="2025-10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° 2025</option>
          <option value="2025-11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô 2025</option>
          <option value="2025-12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2025</option>
        </select>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:22%">Key Project</th>
          <th style="width:26%">Key Activity</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
          <th style="width:12%">Manday</th>
          <th style="width:8%">‡∏•‡∏ö</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="actions">
      <button type="button" class="btn" id="btnAdd">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
      <button type="button" class="btn" id="btnPreview">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
      <button type="submit" class="btn primary" id="btnSubmitReal">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button type="button" class="btn danger hidden" id="btnReset">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
    </div>
    <div id="msg" class="muted"></div>
  </form>

  <div id="preview">
    <h3>üìã ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</h3>
    <div id="previewBody"></div>
    <div class="actions">
      <button type="button" class="btn primary" id="btnConfirm">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á</button>
      <button type="button" class="btn" id="btnBack">üîÑ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </div>
  </div>

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
  <div id="manageSection" class="hidden">
    <h3>üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
    
    <div class="search-box">
      <div style="flex:1">
        <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="searchName" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
      </div>
      <button type="button" class="btn primary" onclick="loadMyData()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>

    <div id="dataList"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
  <script>
    // ===== CONFIG =====
    const MAKE_WEBHOOK_URL = 'https://hook.us2.make.com/q7mp7j5z5ipz7so4p8mclhh83bbm5esh';
    const SHARED_SECRET = 'olala567';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzUqWym78BL1vysGNvRjO5JYXy46vXcSvdXrkLbHoUqNUFGVwii4Q-C3ssDqRGSPDZd/exec'; // ‚ö†Ô∏è ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Deploy

    // ===== Activity Map =====
    const activityMap = {
      "Y1 Engagement": ["Y1-1 Survey Engagement","Y1-2 Engagement & Communication & Training Plan ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà","Y1-2 Engagement & Communication & Training Plan ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô"],
      "Y2 Career Development": ["Y2-1 ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Competency","Y2-2 HRD Training Development Language Proficiency Development Program","Y2-2 HRD Training Development Functional Competency based Development Program","Y2-2 HRD Training Development IT Proficiency Development Program","Y2-2 HRD Training Development ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á Career Development"],
      "Y3 Quality Management System": ["Y3-1 ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ISO 9001","Y3-1 ISO 9001 Meeting ‡∏™‡∏Ñ.","Y3-1 ISO 9001 Document Control ‡πÅ‡∏•‡∏∞ QM/PM/I/F ‡∏£‡∏ß‡∏° (XX-NS-MG-XXX)","Y3-1 ISO 9001 e-CAR/PAR System","Y3-1 ISO 9001 Management Review","Y3-1 ISO 9001 Internal Audit","Y3-1 ISO 9001 External Audit"],
      "Y6 Meeting": ["Y6-1 ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° MCM","Y6-2 ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° OM","Y6-3 ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° HR Top / XAB"],
      "‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢": ["iService","HRSS","‡∏á‡∏≤‡∏ô‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå","‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ù‡πà‡∏≤‡∏¢ / ‡∏á‡∏≤‡∏ô","‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ"]
    };

    const f = document.getElementById('productivity-form');
    const tbody = document.getElementById('rows');
    let isSending = false;

    document.addEventListener('DOMContentLoaded', () => {
      flatpickr('#date', { dateFormat:'d/m/Y', locale:'th', defaultDate:'today', disableMobile:true, allowInput:true });
      addRow();
    });

    // ===== Mode Switching =====
    function showMode(mode) {
      if (mode === 'create') {
        f.classList.remove('hidden');
        document.getElementById('preview').style.display = 'none';
        document.getElementById('manageSection').classList.add('hidden');
        document.getElementById('btnModeCreate').classList.add('active');
        document.getElementById('btnModeManage').classList.remove('active');
      } else {
        f.classList.add('hidden');
        document.getElementById('preview').style.display = 'none';
        document.getElementById('manageSection').classList.remove('hidden');
        document.getElementById('btnModeCreate').classList.remove('active');
        document.getElementById('btnModeManage').classList.add('active');
      }
    }

    // ===== Load User Data =====
    async function loadMyData() {
      const name = document.getElementById('searchName').value.trim();
      if (!name) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠');
        return;
      }

      const listDiv = document.getElementById('dataList');
      listDiv.innerHTML = '<p style="text-align:center">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</p>';

      try {
        const url = `${APPS_SCRIPT_URL}?action=list&name=${encodeURIComponent(name)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data.length) {
          listDiv.innerHTML = '<p style="text-align:center;color:#999">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
          return;
        }

        let html = '<div class="data-table"><table><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>Project</th><th>Activity</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>Manday</th><th style="width:150px">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>';

        data.forEach(row => {
          html += `
            <tr id="row-${row.rowNumber}">
              <td>${row.date}</td>
              <td>${row.key_project}</td>
              <td>${row.key_activity}</td>
              <td><textarea id="detail-${row.rowNumber}">${row.detail}</textarea></td>
              <td><input type="number" id="manday-${row.rowNumber}" value="${row.manday}" step="0.01"></td>
              <td>
                <button class="btn" onclick="updateRow(${row.rowNumber})">üíæ</button>
                <button class="btn danger" onclick="deleteRow(${row.rowNumber})">üóëÔ∏è</button>
              </td>
            </tr>
          `;
        });

        html += '</tbody></table></div>';
        listDiv.innerHTML = html;
      } catch (err) {
        console.error(err);
        listDiv.innerHTML = '<p style="text-align:center;color:red">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>';
      }
    }

    async function updateRow(rowNumber) {
      const detail = document.getElementById(`detail-${rowNumber}`).value;
      const manday = document.getElementById(`manday-${rowNumber}`).value;

      try {
        const url = `${APPS_SCRIPT_URL}?action=update&rowNumber=${rowNumber}&detail=${encodeURIComponent(detail)}&manday=${manday}`;
        await fetch(url);
        alert('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } catch (err) {
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      }
    }

    async function deleteRow(rowNumber) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) return;

      try {
        const url = `${APPS_SCRIPT_URL}?action=delete&rowNumber=${rowNumber}`;
        await fetch(url);
        document.getElementById(`row-${rowNumber}`).remove();
        alert('‚úÖ ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } catch (err) {
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      }
    }

    // ===== Form Functions (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) =====
    function addRow() {
      const id = 'act-' + Date.now() + '-' + Math.random().toString(16).slice(2);
      const tr = document.createElement('tr');
      const optsProject = Object.keys(activityMap).map(k => `<option value="${k}">${k}</option>`).join('');
      tr.innerHTML = `
        <td><select name="key_project[]" onchange="updateActivities(this,'${id}')" required><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Key Project --</option>${optsProject}</select></td>
        <td><select name="key_activity[]" id="${id}" required><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Key Activity --</option></select></td>
        <td><textarea name="detail[]" rows="3" required></textarea></td>
        <td><input type="number" name="manday[]" step="0.01" min="0" required></td>
        <td style="text-align:center"><button type="button" class="btn" onclick="this.closest('tr').remove()">‡∏•‡∏ö</button></td>
      `;
      tbody.appendChild(tr);
    }

    window.updateActivities = function(sel, targetId){
      const v = sel.value;
      const target = document.getElementById(targetId);
      target.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Key Activity --</option>';
      (activityMap[v] || []).forEach(act => {
        const o = document.createElement('option'); o.value = act; o.textContent = act; target.appendChild(o);
      });
    };

    document.getElementById('btnAdd').onclick = addRow;

    document.getElementById('btnPreview').onclick = () => {
      if (!f.reportValidity()) return;
      const fd = new FormData(f);
      const projects = [...f.querySelectorAll('select[name="key_project[]"]')].map(el => el.value);
      const activities = [...f.querySelectorAll('select[name="key_activity[]"]')].map(el => el.value);
      const details = fd.getAll('detail[]');
      const mandays = fd.getAll('manday[]');

      let html = `<p><b>${fd.get('name')}</b> | ${fd.get('department')} | ${fd.get('unit')}</p><p class="muted">${fd.get('date')} ‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${fd.get('month')}</p><table><thead><tr><th>Project</th><th>Activity</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>Manday</th></tr></thead><tbody>`;
      projects.forEach((p,i) => { html += `<tr><td>${p}</td><td>${activities[i]||''}</td><td>${details[i]||''}</td><td>${mandays[i]||''}</td></tr>`; });
      html += '</tbody></table>';

      document.getElementById('previewBody').innerHTML = html;
      f.classList.add('hidden');
      document.getElementById('preview').style.display = 'block';
    };

    document.getElementById('btnBack').onclick = () => {
      document.getElementById('preview').style.display = 'none';
      f.classList.remove('hidden');
    };

    f.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isSending) return;
      isSending = true;
      
      try {
        const result = await sendToMake();
        document.getElementById('msg').textContent = `‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${result.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        document.getElementById('preview').style.display = 'none';
        f.classList.remove('hidden');
        document.getElementById('btnReset').classList.remove('hidden');
      } catch (err) {
        document.getElementById('msg').textContent = '‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      } finally {
        isSending = false;
      }
    });

    document.getElementById('btnConfirm').onclick = () => f.requestSubmit();

    document.getElementById('btnReset').onclick = () => {
      f.reset();
      tbody.innerHTML = '';
      addRow();
      document.getElementById('btnReset').classList.add('hidden');
      document.getElementById('msg').textContent = '';
    };

    async function sendToMake(){
      const fd = new FormData(f);
      const keyProjects = [...document.querySelectorAll('select[name="key_project[]"]')].map(el => el.value);
      const keyActivities = [...document.querySelectorAll('select[name="key_activity[]"]')].map(el => el.value);
      const details = fd.getAll('detail[]');
      const mandays = fd.getAll('manday[]');
      const recordId = crypto.randomUUID ? crypto.randomUUID() : ('rec_'+Date.now());
      const nowIso = new Date().toISOString();

      const records = keyProjects.map((kp,i) => ({
        recordId, timestamp: nowIso,
        date: fd.get('date'), month: fd.get('month'), name: fd.get('name'),
        department: fd.get('department'), unit: fd.get('unit'),
        key_project: kp || '', key_activity: keyActivities[i] || '',
        detail: details[i] || '', manday: parseFloat(mandays[i] || 0)
      })).filter(r => r.key_project || r.key_activity || r.detail);

      if (!records.length) throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á');

      const out = new FormData();
      out.append('value', JSON.stringify({ secret: SHARED_SECRET, records }));
      const res = await fetch(MAKE_WEBHOOK_URL, { method: 'POST', body: out });
      if (res.status < 200 || res.status >= 300) throw new Error(`HTTP Error: ${res.status}`);
      return { success: true, count: records.length };
    }
  </script>
</body>
</html>